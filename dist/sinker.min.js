#!/usr/bin/env node
"use strict";var ut=Object.create;var M=Object.defineProperty;var ft=Object.getOwnPropertyDescriptor;var xt=Object.getOwnPropertyNames;var gt=Object.getPrototypeOf,kt=Object.prototype.hasOwnProperty;var bt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var St=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of xt(t))!kt.call(e,i)&&i!==n&&M(e,i,{get:()=>t[i],enumerable:!(o=ft(t,i))||o.enumerable});return e};var m=(e,t,n)=>(n=e!=null?ut(gt(e)):{},St(t||!e||!e.__esModule?M(n,"default",{value:e,enumerable:!0}):n,e));var b=bt((qt,k)=>{var f=process||{},v=f.argv||[],u=f.env||{},ht=!(u.NO_COLOR||v.includes("--no-color"))&&(!!u.FORCE_COLOR||v.includes("--color")||f.platform==="win32"||(f.stdout||{}).isTTY&&u.TERM!=="dumb"||!!u.CI),yt=(e,t,n=e)=>o=>{let i=""+o,r=i.indexOf(t,e.length);return~r?e+Ct(i,t,n,r)+t:e+i+t},Ct=(e,t,n,o)=>{let i="",r=0;do i+=e.substring(r,o)+n,r=o+t.length,o=e.indexOf(t,r);while(~o);return i+e.substring(r)},R=(e=ht)=>{let t=e?yt:()=>String;return{isColorSupported:e,reset:t("\x1B[0m","\x1B[0m"),bold:t("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:t("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:t("\x1B[3m","\x1B[23m"),underline:t("\x1B[4m","\x1B[24m"),inverse:t("\x1B[7m","\x1B[27m"),hidden:t("\x1B[8m","\x1B[28m"),strikethrough:t("\x1B[9m","\x1B[29m"),black:t("\x1B[30m","\x1B[39m"),red:t("\x1B[31m","\x1B[39m"),green:t("\x1B[32m","\x1B[39m"),yellow:t("\x1B[33m","\x1B[39m"),blue:t("\x1B[34m","\x1B[39m"),magenta:t("\x1B[35m","\x1B[39m"),cyan:t("\x1B[36m","\x1B[39m"),white:t("\x1B[37m","\x1B[39m"),gray:t("\x1B[90m","\x1B[39m"),bgBlack:t("\x1B[40m","\x1B[49m"),bgRed:t("\x1B[41m","\x1B[49m"),bgGreen:t("\x1B[42m","\x1B[49m"),bgYellow:t("\x1B[43m","\x1B[49m"),bgBlue:t("\x1B[44m","\x1B[49m"),bgMagenta:t("\x1B[45m","\x1B[49m"),bgCyan:t("\x1B[46m","\x1B[49m"),bgWhite:t("\x1B[47m","\x1B[49m"),blackBright:t("\x1B[90m","\x1B[39m"),redBright:t("\x1B[91m","\x1B[39m"),greenBright:t("\x1B[92m","\x1B[39m"),yellowBright:t("\x1B[93m","\x1B[39m"),blueBright:t("\x1B[94m","\x1B[39m"),magentaBright:t("\x1B[95m","\x1B[39m"),cyanBright:t("\x1B[96m","\x1B[39m"),whiteBright:t("\x1B[97m","\x1B[39m"),bgBlackBright:t("\x1B[100m","\x1B[49m"),bgRedBright:t("\x1B[101m","\x1B[49m"),bgGreenBright:t("\x1B[102m","\x1B[49m"),bgYellowBright:t("\x1B[103m","\x1B[49m"),bgBlueBright:t("\x1B[104m","\x1B[49m"),bgMagentaBright:t("\x1B[105m","\x1B[49m"),bgCyanBright:t("\x1B[106m","\x1B[49m"),bgWhiteBright:t("\x1B[107m","\x1B[49m")}};k.exports=R();k.exports.createColors=R});var dt=m(b());var D=m(b());function A(e){if(e)return D.default;let t=n=>String(n??"");return{red:t,yellow:t,blue:t,cyan:t,gray:t,bold:t,dim:t,green:t}}var j=m(require("node:path"));function wt(e,t){let n=j.default.resolve(process.cwd(),t.file);console.error(e.red(e.bold(`Violation found in ${n}:${t.line}`))),console.error(`  ${e.cyan("Sink:")}		${e.yellow(t.sink.sink)}`),console.error(`  ${e.cyan("Category:")}	${t.sink.metadata.name}`),console.error(`  ${e.cyan("Description:")}	${t.sink.metadata.description}`),console.error(`  ${e.cyan("Link:")}		${t.sink.metadata.link}`)}function B(e,t){for(let n of t??[])console.error(`  ${e.gray(`Line ${n.line+1}:`)}	${e.dim(n.text)}`)}function Mt(e,t){B(e,t.context.before),console.error("		Add "+e.yellow(e.bold("// @safe-sink: a short explanation why its safe"))+" here to suppress this finding."),console.error(`  ${e.gray(`Line ${t.line}:`)}	${e.red("(>>) "+e.bold(t.context.offendingLine))}`),B(e,t.context.after)}function L(e,t){if(e.violations.length>0){console.error(t.red(t.bold(`Found ${e.violations.length} violations`)));for(let n of e.violations)wt(t,n),Mt(t,n),console.log("")}}var $={name:"Common Source",description:"A source that can be controlled by an attacker and can lead to XSS if not properly sanitized.",link:"https://portswigger.net/web-security/dom-based",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.URL","document.documentURI","document.URLUnencoded","document.baseURI","document.referrer","window.name","localStorage","sessionStorage","mozIndexedDB","webkitIndexedDB","msIndexedDB","IndexedDB","Database"]};var O={name:"DOM-XSS Sinks",description:"Applying user input to DOM without proper sanitization can lead to DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.write(","document.writeln(",".innerHTML",".outerHTML",".insertAdjacentHTML",".onevent"]};var P={name:"jQuery DOM-XSS Sinks",description:"Applying user input to DOM without proper sanitization can lead to jQuery DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["add(","after(","append(","animate(","insertAfter(","insertBefore(","before(","html(","prepend(","replaceAll(","replaceWith(","wrap(","wrapInner(","wrapAll(","has(","constructor(","init(","index(","jQuery.parseHTML(","$.parseHTML(","jQuery.globalEval(","$.globalEval("]};var I={name:"Open Redirect Sinks",description:"This sink can be used to perform open redirects.",link:"https://portswigger.net/web-security/dom-based/open-redirection",displayContextBefore:!0,displayContextAfter:!0,sinks:[".location","location.host","location.hostname","location.href","location.pathname","location.search","location.protocol","location.assign(","location.replace(","open(",".srcdoc","jQuery.ajax(","$.ajax("]};var T={name:"Cookie Sinks",description:"An improper sanitized or validated value can lead to cookie theft, XSS, open redirects and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/cookie-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.cookie"]};var F={name:"JavaScript Injection Sinks",description:"One of the most dangerous sinks in DOM-based XSS attacks, allowing for arbitrary code execution.",link:"https://portswigger.net/web-security/dom-based/javascript-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["eval(","Function(","setTimeout(","setInterval(","setImmediate(","execCommand(","execScript(","msSetImmediate(","range.createContextualFragment(","crypto.generateCRMFRequest("]};var E={name:"Document-Domain Manipulation Sinks",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/document-domain-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.domain"]};var X={name:"WebSocket-URL Poisoning Sinks",description:"Manipulating the WebSocket URL can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/websocket-url-poisoning",displayContextBefore:!0,displayContextAfter:!1,sinks:["WebSocket"]};var z={name:"Link Manipulation Sinks",description:"Manipulating links can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/link-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:[".href",".src",".action"]};var q={name:"Ajax Request-Header Manipulation Sinks",description:"Manipulating request headers can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["XMLHttpRequest.setRequestHeader(","XMLHttpRequest.open(","XMLHttpRequest.send("]};var V={name:"Local File-Path Manipulation Sinks",description:"Manipulating local file paths can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/local-file-path-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["FileReader.readAsArrayBuffer(","FileReader.readAsBinaryString(","FileReader.readAsDataURL(","FileReader.readAsText(","FileReader.readAsFile(","FileReader.root.getFile("]};var W={name:"Client-Side SQL-Injection Sink",description:"Manipulating SQL queries can lead to SQL injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-sql-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["executeSql"]};var _={name:"HTML5 Storage Manipulation Sinks",description:"Manipulating HTML5 storage can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/html5-storage-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["sessionStorage.setItem","localStorage.setItem"]};var H={name:"XPath Injection Sinks",description:"Manipulating XPath expressions can lead to XPath injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-xpath-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:[".evaluate"]};var N={name:"Client-Side JSON Injection Sinks",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-json-injection",displayContextBefore:!0,displayContextAfter:!0,sinks:["JSON.parse","jQuery.parseJSON","$.parseJSON"]};var U={name:"DOM-Data Manipulation Sinks",description:"Manipulating the document dom can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/dom-data-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:[".setAttribute",".search",".text",".textContent",".innerText",".outerText",".value",".name",".target",".method",".type",".backgroundImage",".cssText",".codebase","document.title","document.implementation.createHTMLDocument","history.pushState","history.replaceState"]};var Q={name:"Denial Of Service Sinks",description:"Denial of Service attacks can cause significant disruptions to services and systems.",link:"https://portswigger.net/web-security/dom-based/denial-of-service",displayContextBefore:!0,displayContextAfter:!1,sinks:["RegExp(","requestFileSystem"]};var J=[$,O,P,I,T,F,E,X,z,q,V,W,_,H,N,U,Q];function vt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Y(e){let t=Rt(new Set(e?.ignoredSinks??[]));if(e?.sinks){let o=new Map;for(let i of t)o.set(i.sink,i);for(let i of e.sinks)for(let r of i.sinks)K(r,o,i);return{sinks:G([...o.values()]),count:o.size}}let n=G(t);return{sinks:n,count:n.length}}function K(e,t,n){if(!e)throw new Error("Sink cannot be empty");if(t.has(e))throw new Error(`Sink "${e}" is already defined`);t.set(e,{sink:e,metadata:n})}function Rt(e){let t=new Map;for(let n of J)for(let o of n.sinks)e.has(o)||K(o,t,n);return[...t.values()]}function G(e){return e.map(t=>{let n=vt(t.sink),o=t.sink.startsWith(".")?"(^|[^\\w]|(?<=\\w))":"(^|[^\\w])",i=new RegExp(o+n+"([^\\w]|$)");return{...t,regex:i}})}var et=m(require("node:path")),x=m(require("node:fs")),h=require("node:fs");function Dt(e,t,n){let o=e.lastIndex,i=t.index,r=n.slice(o,i),a=n.slice(0,o).split(/\r?\n/).length;return{code:r,startLine:a}}function At(){return{scriptOpenRe:/<script\b[^>]*>/gi,scriptCloseRe:/<\/script\s*>/gi}}function Bt(e,t,n){let o=t.exec(n);return o?Dt(e,o,n):null}function Z(e){let t=[],{scriptOpenRe:n,scriptCloseRe:o}=At();for(;n.exec(e)!==null;){o.lastIndex=n.lastIndex;let i=Bt(n,o,e);if(!i)break;t.push(i),n.lastIndex=o.lastIndex}return t}function tt(e){return e.startsWith("//")||e.startsWith("/*")||e.startsWith("*")||e.startsWith("<!--")}function jt(e,t){let n=t;for(;n>=0;){let o=e[n].trim();if(o.includes("@safe-sink"))return!0;if(!(o===""||tt(o)))return!1;n--}return!1}function Lt(e,t,n,o,i,r){let s={before:null,offendingLine:e[t].trim(),after:null};if(r.metadata.displayContextBefore){let a=Math.max(0,t-i.contextDepth);s.before=Array.from({length:t-a},(c,l)=>{let p=a+l;return{line:o+p,text:e[p].trim()}})}if(r.metadata.displayContextAfter){let a=Math.max(t+1),c=Math.min(n,a+i.contextDepth);s.after=Array.from({length:c-a},(l,p)=>{let d=a+p;return{line:o+d,text:e[d].trim()}})}return s}function S(e){let{text:t,displayPath:n,compiledSinks:o,lineOffset:i,options:r}=e,s=t.split(/\r?\n/),a=[],c=s.length;for(let l=0;l<c;l++){let p=s[l],d=p.trim();if(!tt(d))for(let g of o)g.regex.test(p)&&(jt(s,l-1)||a.push({file:n,line:i+l+1,sink:g,context:Lt(s,l,c,i,r,g)}))}return a}var $t=[".ts",".js",".mts",".cts",".mjs",".cjs",".tsx",".jsx"];function nt(e){return x.existsSync(e)}function ot(e){return x.statSync(e)}function it(e){return $t.some(t=>e.endsWith(t))}function Ot(e,t,n){return!e.startsWith(".")&&!y(t,n)}function y(e,t){return t.some(n=>{let o="^"+n.split("*").map(s=>s.replace(/[|\\{}()[\]^$+?.]/g,"\\$&")).join(".*")+"$",i=new RegExp(o),r=e.split(/[/\\]/).pop()||"";return i.test(e)||i.test(r)||e.endsWith(n)})}async function C(e){let{filePath:t,compiledSinks:n,contextDepth:o,ignored:i=[]}=e;if(y(t,i))return{violations:[],count:0};let r=await h.promises.readFile(t,"utf-8");if(it(t))return{violations:S({text:r,displayPath:t,compiledSinks:n,lineOffset:0,options:{contextDepth:o}}),count:1};if(t.endsWith(".html")){let s=Z(r),a=[];for(let c of s)a.push(...S({text:c.code,displayPath:`${t} (<script>)`,compiledSinks:n,lineOffset:c.startLine-1,options:{contextDepth:o}}));return{violations:a,count:1}}return{violations:[],count:1}}async function Pt(e,t,n,o,i){let r=et.join(t,e.name);if(e.isDirectory()){if(Ot(e.name,r,i))return w({dirPath:r,compiledSinks:n,contextDepth:o,ignored:i})}else if(e.isFile()&&(it(e.name)||e.name.endsWith(".html")))return C({filePath:r,compiledSinks:n,contextDepth:o,ignored:i});return{violations:[],count:0}}async function w(e){let{dirPath:t,compiledSinks:n,contextDepth:o,ignored:i=[]}=e;if(y(t,i))return{violations:[],count:0};let r=await h.promises.readdir(t,{withFileTypes:!0}),s={violations:[],count:0};for(let a of r){let c=await Pt(a,t,n,o,i);s.violations.push(...c.violations),s.count+=c.count}return s}var st=m(require("node:path")),at=m(require("node:fs")),ct=require("node:url"),rt={ignoredSinks:[],ignored:["**/dist/**","**/node_modules/**","**/coverage/**","*.test.js","*.spec.js","*.min.js","*.map"],sinks:[],colors:!0,contextDepth:3};async function lt(){let e=st.resolve(process.cwd(),"sinker.config.js");if(at.existsSync(e))try{let n=await import((0,ct.pathToFileURL)(e).href),o=n.default||n;return{...rt,...o}}catch(t){console.warn(`Failed to load config from ${e}:`,t)}return rt}function It(e){let t=e.find(i=>i.startsWith("--context-depth=")),n=t?t.split("=")[1]:void 0,o=n?Number.parseInt(n,10):-1;return Number.isFinite(o)&&o>=0?o:-1}function pt(e){let t=e.slice(2),n=!t.includes("--no-color")&&!t.includes("-nc"),o=t.includes("--help")||t.includes("-h"),i=t.find(s=>!s.startsWith("--")&&!s.startsWith("-"))??".",r=It(t);return{targetLocation:i,options:{useColor:n,contextDepth:r,help:o}}}async function Tt(e){let t=pt(e),n=await lt(),o=t.options.useColor&&n.colors,i=t.options.contextDepth>=0?t.options.contextDepth:n.contextDepth,r=A(o),{sinks:s,count:a}=Y(n);return{args:t,config:n,useColor:o,contextDepth:i,c:r,sinks:s,count:a}}function Ft(e,t){return e===0?(console.error(t.red("No sink rules found")),!1):!0}function Et(e,t){return nt(e)?!0:(console.error(t.red(`Path does not exist: ${e}`)),!1)}function Xt(e){console.log(`
${e.blue("sinker")} - Minimalistic security tool to scan for potentially dangerous sinks and sources.

${e.bold("Usage:")}
  sinker [target] [options]

${e.bold("Arguments:")}
  target                Path to a file or directory to scan (default: .)

${e.bold("Options:")}
  -h, --help            Show this help message
  -nc, --no-color       Disable colored output
  --context-depth=N     Number of lines of context to show (default: from config)

${e.bold("Examples:")}
  sinker .
  sinker src/index.ts --context-depth=5
  sinker --no-color
`)}async function mt(e){let{args:t,config:n,contextDepth:o,c:i,sinks:r,count:s}=await Tt(e);if(t.options.help)return Xt(i),0;if(!Ft(s,i)||!Et(t.targetLocation,i))return 1;console.log(i.blue(`Scanning ${t.targetLocation} for ${s} sinks (context-depth: ${o})...`));let a=ot(t.targetLocation).isDirectory()?await w({dirPath:t.targetLocation,compiledSinks:r,contextDepth:o,ignored:n.ignored}):await C({filePath:t.targetLocation,compiledSinks:r,contextDepth:o,ignored:n.ignored});return console.log(i.blue(`Successfully scanned ${a.count} files`)),a.violations.length>0?(L(a,i),1):(console.log(i.green("Scan completed successfully. No violations found.")),0)}mt(process.argv).then(e=>{process.exitCode=e}).catch(e=>{let t=e instanceof Error?e.message:String(e);console.error(dt.default.red(`Unexpected error: ${t}`)),process.exitCode=1});
//# sourceMappingURL=sinker.min.js.map
