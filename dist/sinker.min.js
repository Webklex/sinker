#!/usr/bin/env node
"use strict";var kt=Object.create;var R=Object.defineProperty;var St=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var ht=Object.getPrototypeOf,yt=Object.prototype.hasOwnProperty;var Ct=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var wt=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of bt(t))!yt.call(e,i)&&i!==n&&R(e,i,{get:()=>t[i],enumerable:!(o=St(t,i))||o.enumerable});return e};var m=(e,t,n)=>(n=e!=null?kt(ht(e)):{},wt(t||!e||!e.__esModule?R(n,"default",{value:e,enumerable:!0}):n,e));var S=Ct((Kt,k)=>{var f=process||{},M=f.argv||[],u=f.env||{},vt=!(u.NO_COLOR||M.includes("--no-color"))&&(!!u.FORCE_COLOR||M.includes("--color")||f.platform==="win32"||(f.stdout||{}).isTTY&&u.TERM!=="dumb"||!!u.CI),Rt=(e,t,n=e)=>o=>{let i=""+o,r=i.indexOf(t,e.length);return~r?e+Mt(i,t,n,r)+t:e+i+t},Mt=(e,t,n,o)=>{let i="",r=0;do i+=e.substring(r,o)+n,r=o+t.length,o=e.indexOf(t,r);while(~o);return i+e.substring(r)},B=(e=vt)=>{let t=e?Rt:()=>String;return{isColorSupported:e,reset:t("\x1B[0m","\x1B[0m"),bold:t("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:t("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:t("\x1B[3m","\x1B[23m"),underline:t("\x1B[4m","\x1B[24m"),inverse:t("\x1B[7m","\x1B[27m"),hidden:t("\x1B[8m","\x1B[28m"),strikethrough:t("\x1B[9m","\x1B[29m"),black:t("\x1B[30m","\x1B[39m"),red:t("\x1B[31m","\x1B[39m"),green:t("\x1B[32m","\x1B[39m"),yellow:t("\x1B[33m","\x1B[39m"),blue:t("\x1B[34m","\x1B[39m"),magenta:t("\x1B[35m","\x1B[39m"),cyan:t("\x1B[36m","\x1B[39m"),white:t("\x1B[37m","\x1B[39m"),gray:t("\x1B[90m","\x1B[39m"),bgBlack:t("\x1B[40m","\x1B[49m"),bgRed:t("\x1B[41m","\x1B[49m"),bgGreen:t("\x1B[42m","\x1B[49m"),bgYellow:t("\x1B[43m","\x1B[49m"),bgBlue:t("\x1B[44m","\x1B[49m"),bgMagenta:t("\x1B[45m","\x1B[49m"),bgCyan:t("\x1B[46m","\x1B[49m"),bgWhite:t("\x1B[47m","\x1B[49m"),blackBright:t("\x1B[90m","\x1B[39m"),redBright:t("\x1B[91m","\x1B[39m"),greenBright:t("\x1B[92m","\x1B[39m"),yellowBright:t("\x1B[93m","\x1B[39m"),blueBright:t("\x1B[94m","\x1B[39m"),magentaBright:t("\x1B[95m","\x1B[39m"),cyanBright:t("\x1B[96m","\x1B[39m"),whiteBright:t("\x1B[97m","\x1B[39m"),bgBlackBright:t("\x1B[100m","\x1B[49m"),bgRedBright:t("\x1B[101m","\x1B[49m"),bgGreenBright:t("\x1B[102m","\x1B[49m"),bgYellowBright:t("\x1B[103m","\x1B[49m"),bgBlueBright:t("\x1B[104m","\x1B[49m"),bgMagentaBright:t("\x1B[105m","\x1B[49m"),bgCyanBright:t("\x1B[106m","\x1B[49m"),bgWhiteBright:t("\x1B[107m","\x1B[49m")}};k.exports=B();k.exports.createColors=B});var xt=m(S());var $=m(S());function D(e){if(e)return $.default;let t=n=>String(n??"");return{red:t,yellow:t,blue:t,cyan:t,gray:t,bold:t,dim:t,green:t}}var A=m(require("node:path"));function I(e,t,n,o=!0){let{sink:i,context:r}=e,a=A.default.resolve(process.cwd(),e.file),s="";return n?(o&&(s+=t.gray(`File: ${a}:${e.line}
`)),s+`Sinker found a potential ${t.red(e.sink.metadata.name.toLowerCase())} '${t.yellow(e.sink.sink)}'`):(s+=`
${t.red(t.bold(`Violation found in: ${a}:${e.line}`))}`,s+=`
  ${t.cyan("Sink:")}		${t.yellow(i.sink)}`,s+=`
  ${t.cyan("Category:")}	${i.metadata.name}`,i.metadata.description&&(s+=`
  ${t.cyan("Description:")}	${i.metadata.description}`),i.metadata.link&&(s+=`
  ${t.cyan("Link:")}		${i.metadata.link}`),s+=Bt(r,t),s+=`
		Add `+t.yellow(t.bold("// @safe-sink: a short explanation why its safe"))+" here to suppress this finding.",s+=`
  ${t.gray(`Line ${e.line}:`)}	${t.red("(>>) "+t.bold(r.offendingLine))}`,s+=$t(r,t),s)}function Bt(e,t){let n="";if(e.before&&e.before.length)for(let o of e.before)n+=`
  ${t.gray(`Line ${o.line+1}:`)}	${t.dim(o.text)}`;return n}function $t(e,t){let n="";if(e.after&&e.after.length)for(let o of e.after)n+=`
  ${t.gray(`Line ${o.line+1}:`)}	${t.dim(o.text)}`;return n}function O(e,t,n,o=!0){if(e.violations.length>0){console.error(t.red(t.bold(`Found ${e.violations.length} violations`)));for(let i of e.violations)console.error(I(i,t,n,o)),n||console.log("")}}var L={name:"Common Source",description:"A source that can be controlled by an attacker and can lead to XSS if not properly sanitized.",link:"https://portswigger.net/web-security/dom-based",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.URL","document.documentURI","document.URLUnencoded","document.baseURI","document.referrer","window.name","localStorage","sessionStorage","mozIndexedDB","webkitIndexedDB","msIndexedDB","IndexedDB","Database"]};var j={name:"DOM-XSS Sink",description:"Applying user input to DOM without proper sanitization can lead to DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.write(","document.writeln(",".innerHTML",".outerHTML",".insertAdjacentHTML",".onevent"]};var E={name:"jQuery DOM-XSS Sink",description:"Applying user input to DOM without proper sanitization can lead to jQuery DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["add(","after(","append(","animate(","insertAfter(","insertBefore(","before(","html(","prepend(","replaceAll(","replaceWith(","wrap(","wrapInner(","wrapAll(","has(","constructor(","init(","index(","jQuery.parseHTML(","$.parseHTML(","jQuery.globalEval(","$.globalEval("]};var F={name:"Open Redirect Sink",description:"This sink can be used to perform open redirects.",link:"https://portswigger.net/web-security/dom-based/open-redirection",displayContextBefore:!0,displayContextAfter:!0,sinks:[".location","location.host","location.hostname","location.href","location.pathname","location.search","location.protocol","location.assign(","location.replace(","open(",".srcdoc","jQuery.ajax(","$.ajax("]};var P={name:"Cookie Sink",description:"An improper sanitized or validated value can lead to cookie theft, XSS, open redirects and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/cookie-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.cookie"]};var _={name:"JavaScript Injection Sink",description:"One of the most dangerous sinks in DOM-based XSS attacks, allowing for arbitrary code execution.",link:"https://portswigger.net/web-security/dom-based/javascript-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["eval(","Function(","setTimeout(","setInterval(","setImmediate(","execCommand(","execScript(","msSetImmediate(","range.createContextualFragment(","crypto.generateCRMFRequest("]};var T={name:"Document-Domain Manipulation Sink",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/document-domain-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.domain"]};var N={name:"WebSocket-URL Poisoning Sink",description:"Manipulating the WebSocket URL can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/websocket-url-poisoning",displayContextBefore:!0,displayContextAfter:!1,sinks:["WebSocket"]};var q={name:"Link Manipulation Sink",description:"Manipulating links can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/link-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:[".href",".src",".action"]};var V={name:"Ajax Request-Header Manipulation Sink",description:"Manipulating request headers can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["XMLHttpRequest.setRequestHeader(","XMLHttpRequest.open(","XMLHttpRequest.send("]};var z={name:"Local File-Path Manipulation Sink",description:"Manipulating local file paths can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/local-file-path-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["FileReader.readAsArrayBuffer(","FileReader.readAsBinaryString(","FileReader.readAsDataURL(","FileReader.readAsText(","FileReader.readAsFile(","FileReader.root.getFile("]};var X={name:"Client-Side SQL-Injection Sink",description:"Manipulating SQL queries can lead to SQL injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-sql-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["executeSql"]};var H={name:"HTML5 Storage Manipulation Sink",description:"Manipulating HTML5 storage can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/html5-storage-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["sessionStorage.setItem","localStorage.setItem"]};var W={name:"XPath Injection Sink",description:"Manipulating XPath expressions can lead to XPath injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-xpath-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:[".evaluate"]};var U={name:"Client-Side JSON Injection Sink",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-json-injection",displayContextBefore:!0,displayContextAfter:!0,sinks:["JSON.parse","jQuery.parseJSON","$.parseJSON"]};var Q={name:"DOM-Data Manipulation Sink",description:"Manipulating the document dom can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/dom-data-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:[".setAttribute",".search",".text",".textContent",".innerText",".outerText",".value",".name",".target",".method",".type",".backgroundImage",".cssText",".codebase","document.title","document.implementation.createHTMLDocument","history.pushState","history.replaceState"]};var G={name:"Denial Of Service Sink",description:"Denial of Service attacks can cause significant disruptions to services and systems.",link:"https://portswigger.net/web-security/dom-based/denial-of-service",displayContextBefore:!0,displayContextAfter:!1,sinks:["RegExp(","requestFileSystem"]};var J=[L,j,E,F,P,_,T,N,q,V,z,X,H,W,U,Q,G];function Dt(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function At(e){let t=new Map;for(let n of e)t.set(n.sink,n);return t}function Y(e){let t=It(new Set(e?.ignoredSinks??[]));if(e?.sinks){let o=At(t);for(let i of e.sinks)for(let r of i.sinks)Z(r,o,i);return{sinks:K([...o.values()]),count:o.size}}let n=K(t);return{sinks:n,count:n.length}}function Z(e,t,n){if(!e)throw new Error("Sink cannot be empty");if(t.has(e))throw new Error(`Sink "${e}" is already defined`);t.set(e,{sink:e,metadata:n})}function It(e){let t=new Map;for(let n of J)for(let o of n.sinks)e.has(o)||Z(o,t,n);return[...t.values()]}function K(e){return e.map(t=>{let n=Dt(t.sink),o=t.sink.startsWith(".")?"(^|[^\\w]|(?<=\\w))":"(^|[^\\w])",i=new RegExp(o+n+"([^\\w]|$)");return{...t,regex:i}})}var nt=m(require("path")),g=m(require("fs")),h=require("fs");function Ot(e,t,n){let o=e.lastIndex,i=t.index,r=n.slice(o,i),s=n.slice(0,o).split(/\r?\n/).length;return{code:r,startLine:s}}function Lt(){return{scriptOpenRe:/<script\b[^>]*>/gi,scriptCloseRe:/<\/script\s*>/gi}}function jt(e,t,n){let o=t.exec(n);return o?Ot(e,o,n):null}function tt(e){let t=[],{scriptOpenRe:n,scriptCloseRe:o}=Lt();for(;n.exec(e)!==null;){o.lastIndex=n.lastIndex;let i=jt(n,o,e);if(!i)break;t.push(i),n.lastIndex=o.lastIndex}return t}function et(e){return e.startsWith("//")||e.startsWith("/*")||e.startsWith("*")||e.startsWith("<!--")}function Et(e,t){let n=t;for(;n>=0;){let o=e[n].trim();if(o.includes("@safe-sink"))return!0;if(!(o===""||et(o)))return!1;n--}return!1}function Ft(e,t,n,o,i,r){let a={before:null,offendingLine:e[t].trim(),after:null};if(r.metadata.displayContextBefore){let s=Math.max(0,t-i.contextDepth);a.before=Array.from({length:t-s},(l,c)=>{let p=s+c;return{line:o+p,text:e[p].trim()}})}if(r.metadata.displayContextAfter){let s=Math.max(t+1),l=Math.min(n,s+i.contextDepth);a.after=Array.from({length:l-s},(c,p)=>{let d=s+p;return{line:o+d,text:e[d].trim()}})}return a}function b(e){let{text:t,displayPath:n,compiledSinks:o,lineOffset:i,options:r}=e,a=t.split(/\r?\n/),s=[],l=a.length;for(let c=0;c<l;c++){let p=a[c],d=p.trim();if(!et(d))for(let x of o)x.regex.test(p)&&(Et(a,c-1)||s.push({file:n,line:i+c+1,sink:x,context:Ft(a,c,l,i,r,x)}))}return s}var Pt=[".ts",".js",".mts",".cts",".mjs",".cjs",".tsx",".jsx"];function ot(e){return g.existsSync(e)}function it(e){return g.statSync(e)}function rt(e){return Pt.some(t=>e.endsWith(t))}function _t(e,t,n){return!e.startsWith(".")&&!y(t,n)}function y(e,t){return t.some(n=>{let o="^"+n.split("*").map(a=>a.replace(/[|\\{}()[\]^$+?.]/g,"\\$&")).join(".*")+"$",i=new RegExp(o),r=e.split(/[/\\]/).pop()||"";return i.test(e)||i.test(r)||e.endsWith(n)})}async function C(e){let{filePath:t,compiledSinks:n,contextDepth:o,ignored:i=[]}=e;if(y(t,i))return{violations:[],count:0};let r=await h.promises.readFile(t,"utf-8");if(rt(t))return{violations:b({text:r,displayPath:t,compiledSinks:n,lineOffset:0,options:{contextDepth:o}}),count:1};if(t.endsWith(".html")){let a=tt(r),s=[];for(let l of a)s.push(...b({text:l.code,displayPath:`${t} (<script>)`,compiledSinks:n,lineOffset:l.startLine-1,options:{contextDepth:o}}));return{violations:s,count:1}}return{violations:[],count:1}}async function Tt(e,t,n,o,i){let r=nt.join(t,e.name);if(e.isDirectory()){if(_t(e.name,r,i))return w({dirPath:r,compiledSinks:n,contextDepth:o,ignored:i})}else if(e.isFile()&&(rt(e.name)||e.name.endsWith(".html")))return C({filePath:r,compiledSinks:n,contextDepth:o,ignored:i});return{violations:[],count:0}}async function w(e){let{dirPath:t,compiledSinks:n,contextDepth:o,ignored:i=[]}=e;if(y(t,i))return{violations:[],count:0};let r=await h.promises.readdir(t,{withFileTypes:!0}),a={violations:[],count:0};for(let s of r){let l=await Tt(s,t,n,o,i);a.violations.push(...l.violations),a.count+=l.count}return a}var ct=m(require("path")),pt=m(require("fs")),mt=require("url");var st="1.1.0",at="sinker.config.js";var v=st??process.env.npm_package_version??"0.0.0",lt=at??"sinker.config.js";var dt={ignoredSinks:[],ignored:["**/dist/**","**/node_modules/**","**/coverage/**","*.test.js","*.spec.js","*.min.js","*.map"],sinks:[],colors:!0,minimal:!0,contextDepth:3};function qt(e){return{...dt,...e}}function Vt(e,t){console.warn(`Failed to load config from ${e}. Using default config.`,t)}function zt(){return ct.resolve(process.cwd(),lt)}async function ut(){let e=zt();if(pt.existsSync(e))try{let n=await import((0,mt.pathToFileURL)(e).href);return qt(n.default||n)}catch(t){Vt(e,t)}return dt}function Xt(e){let t=e.find(i=>i.startsWith("--context-depth=")),n=t?t.split("=")[1]:void 0,o=n?Number.parseInt(n,10):-1;return Number.isFinite(o)&&o>=0?o:-1}function ft(e){let t=e.slice(2),n=!t.includes("--no-color")&&!t.includes("-nc"),o=!t.includes("--minimal")&&!t.includes("-m"),i=t.includes("--help")||t.includes("-h"),r=t.includes("--version")||t.includes("-v"),a=t.find(l=>!l.startsWith("--")&&!l.startsWith("-"))??".",s=Xt(t);return{targetLocation:a,options:{useColor:n,minimal:o,contextDepth:s,help:i,version:r}}}async function Ht(e){let t=ft(e),n=await ut(),o=t.options.useColor&&n.colors,i=t.options.minimal&&n.minimal,r=t.options.contextDepth>=0?t.options.contextDepth:n.contextDepth,a=D(o),{sinks:s,count:l}=Y(n);return{args:t,config:n,minimal:i,useColor:o,contextDepth:r,c:a,sinks:s,count:l}}function Wt(e,t){return e===0?(console.error(t.red("No sink rules found")),!1):!0}function Ut(e,t){return ot(e)?!0:(console.error(t.red(`Path does not exist: ${e}`)),!1)}function Qt(e){console.log(`
${e.blue("sinker")} v${v} - Minimalistic security tool to scan for potentially dangerous sinks and sources.

${e.bold("Usage:")}
  sinker [target] [options]

${e.bold("Arguments:")}
  target                Path to a file or directory to scan (default: .)

${e.bold("Options:")}
  -h, --help            Show this help message
  -m, --minimal         Show only minimal output (no colors, no context)         
  -nc, --no-color       Disable colored output
  --context-depth=N     Number of lines of context to show (default: from config)

${e.bold("Examples:")}
  sinker .
  sinker src/index.ts --context-depth=5
  sinker src/index.ts --no-color -m -h
`)}function Gt(e){console.log(`${e.blue("sinker")} v${v}`)}async function gt(e){let{args:t,config:n,contextDepth:o,minimal:i,c:r,sinks:a,count:s}=await Ht(e);if(t.options.help)return Qt(r),0;if(t.options.version)return Gt(r),0;if(!Wt(s,r)||!Ut(t.targetLocation,r))return 1;console.log(r.blue(`Scanning ${t.targetLocation} for ${s} sinks (context-depth: ${o})...`));let l=it(t.targetLocation).isDirectory()?await w({dirPath:t.targetLocation,compiledSinks:a,contextDepth:o,ignored:n.ignored}):await C({filePath:t.targetLocation,compiledSinks:a,contextDepth:o,ignored:n.ignored});return console.log(r.blue(`Successfully scanned ${l.count} files`)),l.violations.length>0?(O(l,r,i),1):(console.log(r.green("Scan completed successfully. No violations found.")),0)}gt(process.argv).then(e=>{process.exitCode=e}).catch(e=>{let t=e instanceof Error?e.message:String(e);console.error(xt.default.red(`Unexpected error: ${t}`)),process.exitCode=1});
