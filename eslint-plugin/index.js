"use strict";var at=Object.create;var b=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,pt=Object.prototype.hasOwnProperty;var ut=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var dt=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ct(t))!pt.call(e,o)&&o!==n&&b(e,o,{get:()=>t[o],enumerable:!(i=lt(t,o))||i.enumerable});return e};var u=(e,t,n)=>(n=e!=null?at(mt(e)):{},dt(t||!e||!e.__esModule?b(n,"default",{value:e,enumerable:!0}):n,e));var H=ut((Se,S)=>{var f=process||{},N=f.argv||[],d=f.env||{},bt=!(d.NO_COLOR||N.includes("--no-color"))&&(!!d.FORCE_COLOR||N.includes("--color")||f.platform==="win32"||(f.stdout||{}).isTTY&&d.TERM!=="dumb"||!!d.CI),ht=(e,t,n=e)=>i=>{let o=""+i,s=o.indexOf(t,e.length);return~s?e+yt(o,t,n,s)+t:e+o+t},yt=(e,t,n,i)=>{let o="",s=0;do o+=e.substring(s,i)+n,s=i+t.length,i=e.indexOf(t,s);while(~i);return o+e.substring(s)},V=(e=bt)=>{let t=e?ht:()=>String;return{isColorSupported:e,reset:t("\x1B[0m","\x1B[0m"),bold:t("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:t("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:t("\x1B[3m","\x1B[23m"),underline:t("\x1B[4m","\x1B[24m"),inverse:t("\x1B[7m","\x1B[27m"),hidden:t("\x1B[8m","\x1B[28m"),strikethrough:t("\x1B[9m","\x1B[29m"),black:t("\x1B[30m","\x1B[39m"),red:t("\x1B[31m","\x1B[39m"),green:t("\x1B[32m","\x1B[39m"),yellow:t("\x1B[33m","\x1B[39m"),blue:t("\x1B[34m","\x1B[39m"),magenta:t("\x1B[35m","\x1B[39m"),cyan:t("\x1B[36m","\x1B[39m"),white:t("\x1B[37m","\x1B[39m"),gray:t("\x1B[90m","\x1B[39m"),bgBlack:t("\x1B[40m","\x1B[49m"),bgRed:t("\x1B[41m","\x1B[49m"),bgGreen:t("\x1B[42m","\x1B[49m"),bgYellow:t("\x1B[43m","\x1B[49m"),bgBlue:t("\x1B[44m","\x1B[49m"),bgMagenta:t("\x1B[45m","\x1B[49m"),bgCyan:t("\x1B[46m","\x1B[49m"),bgWhite:t("\x1B[47m","\x1B[49m"),blackBright:t("\x1B[90m","\x1B[39m"),redBright:t("\x1B[91m","\x1B[39m"),greenBright:t("\x1B[92m","\x1B[39m"),yellowBright:t("\x1B[93m","\x1B[39m"),blueBright:t("\x1B[94m","\x1B[39m"),magentaBright:t("\x1B[95m","\x1B[39m"),cyanBright:t("\x1B[96m","\x1B[39m"),whiteBright:t("\x1B[97m","\x1B[39m"),bgBlackBright:t("\x1B[100m","\x1B[49m"),bgRedBright:t("\x1B[101m","\x1B[49m"),bgGreenBright:t("\x1B[102m","\x1B[49m"),bgYellowBright:t("\x1B[103m","\x1B[49m"),bgBlueBright:t("\x1B[104m","\x1B[49m"),bgMagentaBright:t("\x1B[105m","\x1B[49m"),bgCyanBright:t("\x1B[106m","\x1B[49m"),bgWhiteBright:t("\x1B[107m","\x1B[49m")}};S.exports=V();S.exports.createColors=V});var h={name:"Common Source",description:"A source that can be controlled by an attacker and can lead to XSS if not properly sanitized.",link:"https://portswigger.net/web-security/dom-based",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.URL","document.documentURI","document.URLUnencoded","document.baseURI","document.referrer","window.name","localStorage","sessionStorage","mozIndexedDB","webkitIndexedDB","msIndexedDB","IndexedDB","Database"]};var y={name:"DOM-XSS Sink",description:"Applying user input to DOM without proper sanitization can lead to DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.write(","document.writeln(",".innerHTML",".outerHTML",".insertAdjacentHTML",".onevent"]};var C={name:"jQuery DOM-XSS Sink",description:"Applying user input to DOM without proper sanitization can lead to jQuery DOM-based XSS.",link:"https://portswigger.net/web-security/cross-site-scripting/dom-based",displayContextBefore:!0,displayContextAfter:!1,sinks:["add(","after(","append(","animate(","insertAfter(","insertBefore(","before(","html(","prepend(","replaceAll(","replaceWith(","wrap(","wrapInner(","wrapAll(","has(","constructor(","init(","index(","jQuery.parseHTML(","$.parseHTML(","jQuery.globalEval(","$.globalEval("]};var w={name:"Open Redirect Sink",description:"This sink can be used to perform open redirects.",link:"https://portswigger.net/web-security/dom-based/open-redirection",displayContextBefore:!0,displayContextAfter:!0,sinks:[".location","location.host","location.hostname","location.href","location.pathname","location.search","location.protocol","location.assign(","location.replace(","open(",".srcdoc","jQuery.ajax(","$.ajax("]};var R={name:"Cookie Sink",description:"An improper sanitized or validated value can lead to cookie theft, XSS, open redirects and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/cookie-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["document.cookie"]};var M={name:"JavaScript Injection Sink",description:"One of the most dangerous sinks in DOM-based XSS attacks, allowing for arbitrary code execution.",link:"https://portswigger.net/web-security/dom-based/javascript-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["eval(","Function(","setTimeout(","setInterval(","setImmediate(","execCommand(","execScript(","msSetImmediate(","range.createContextualFragment(","crypto.generateCRMFRequest("]};var B={name:"Document-Domain Manipulation Sink",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/document-domain-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["document.domain"]};var O={name:"WebSocket-URL Poisoning Sink",description:"Manipulating the WebSocket URL can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/websocket-url-poisoning",displayContextBefore:!0,displayContextAfter:!1,sinks:["WebSocket"]};var v={name:"Link Manipulation Sink",description:"Manipulating links can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/link-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:[".href",".src",".action"]};var I={name:"Ajax Request-Header Manipulation Sink",description:"Manipulating request headers can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["XMLHttpRequest.setRequestHeader(","XMLHttpRequest.open(","XMLHttpRequest.send("]};var j={name:"Local File-Path Manipulation Sink",description:"Manipulating local file paths can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/local-file-path-manipulation",displayContextBefore:!0,displayContextAfter:!0,sinks:["FileReader.readAsArrayBuffer(","FileReader.readAsBinaryString(","FileReader.readAsDataURL(","FileReader.readAsText(","FileReader.readAsFile(","FileReader.root.getFile("]};var D={name:"Client-Side SQL-Injection Sink",description:"Manipulating SQL queries can lead to SQL injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-sql-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:["executeSql"]};var A={name:"HTML5 Storage Manipulation Sink",description:"Manipulating HTML5 storage can lead to cross-site scripting (XSS) attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/html5-storage-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:["sessionStorage.setItem","localStorage.setItem"]};var L={name:"XPath Injection Sink",description:"Manipulating XPath expressions can lead to XPath injection vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-xpath-injection",displayContextBefore:!0,displayContextAfter:!1,sinks:[".evaluate"]};var $={name:"Client-Side JSON Injection Sink",description:"Manipulating the document domain can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/client-side-json-injection",displayContextBefore:!0,displayContextAfter:!0,sinks:["JSON.parse","jQuery.parseJSON","$.parseJSON"]};var F={name:"DOM-Data Manipulation Sink",description:"Manipulating the document dom can lead to cross-domain attacks and other vulnerabilities.",link:"https://portswigger.net/web-security/dom-based/dom-data-manipulation",displayContextBefore:!0,displayContextAfter:!1,sinks:[".setAttribute",".search",".text",".textContent",".innerText",".outerText",".value",".name",".target",".method",".type",".backgroundImage",".cssText",".codebase","document.title","document.implementation.createHTMLDocument","history.pushState","history.replaceState"]};var E={name:"Denial Of Service Sink",description:"Denial of Service attacks can cause significant disruptions to services and systems.",link:"https://portswigger.net/web-security/dom-based/denial-of-service",displayContextBefore:!0,displayContextAfter:!1,sinks:["RegExp(","requestFileSystem"]};var P=[h,y,C,w,R,M,B,O,v,I,j,D,A,L,$,F,E];function ft(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function gt(e){let t=new Map;for(let n of e)t.set(n.sink,n);return t}function _(e){let t=xt(new Set(e?.ignoredSinks??[]));if(e?.sinks){let i=gt(t);for(let o of e.sinks)for(let s of o.sinks)q(s,i,o);return{sinks:T([...i.values()]),count:i.size}}let n=T(t);return{sinks:n,count:n.length}}function q(e,t,n){if(!e)throw new Error("Sink cannot be empty");if(t.has(e))throw new Error(`Sink "${e}" is already defined`);t.set(e,{sink:e,metadata:n})}function xt(e){let t=new Map;for(let n of P)for(let i of n.sinks)e.has(i)||q(i,t,n);return[...t.values()]}function T(e){return e.map(t=>{let n=ft(t.sink),i=t.sink.startsWith(".")?"(^|[^\\w]|(?<=\\w))":"(^|[^\\w])",o=new RegExp(i+n+"([^\\w]|$)");return{...t,regex:o}})}function X(e){return e.startsWith("//")||e.startsWith("/*")||e.startsWith("*")||e.startsWith("<!--")}function kt(e,t){let n=t;for(;n>=0;){let i=e[n].trim();if(i.includes("@safe-sink"))return!0;if(!(i===""||X(i)))return!1;n--}return!1}function St(e,t,n,i,o,s){let a={before:null,offendingLine:e[t].trim(),after:null};if(s.metadata.displayContextBefore){let r=Math.max(0,t-o.contextDepth);a.before=Array.from({length:t-r},(m,l)=>{let c=r+l;return{line:i+c,text:e[c].trim()}})}if(s.metadata.displayContextAfter){let r=Math.max(t+1),m=Math.min(n,r+o.contextDepth);a.after=Array.from({length:m-r},(l,c)=>{let p=r+c;return{line:i+p,text:e[p].trim()}})}return a}function k(e){let{text:t,displayPath:n,compiledSinks:i,lineOffset:o,options:s}=e,a=t.split(/\r?\n/),r=[],m=a.length;for(let l=0;l<m;l++){let c=a[l],p=c.trim();if(!X(p))for(let x of i)x.regex.test(c)&&(kt(a,l-1)||r.push({file:n,line:o+l+1,sink:x,context:St(a,l,m,o,s,x)}))}return r}var W=u(H());function z(e){if(e)return W.default;let t=n=>String(n??"");return{red:t,yellow:t,blue:t,cyan:t,gray:t,bold:t,dim:t,green:t}}var U=u(require("node:path"));function Q(e,t,n,i=!0){let{sink:o,context:s}=e,a=U.default.resolve(process.cwd(),e.file),r="";return n?(i&&(r+=t.gray(`File: ${a}:${e.line}
`)),r+`Sinker found a potential ${t.red(e.sink.metadata.name.toLowerCase())} '${t.yellow(e.sink.sink)}'`):(r+=`
${t.red(t.bold(`Violation found in: ${a}:${e.line}`))}`,r+=`
  ${t.cyan("Sink:")}		${t.yellow(o.sink)}`,r+=`
  ${t.cyan("Category:")}	${o.metadata.name}`,o.metadata.description&&(r+=`
  ${t.cyan("Description:")}	${o.metadata.description}`),o.metadata.link&&(r+=`
  ${t.cyan("Link:")}		${o.metadata.link}`),r+=Ct(s,t),r+=`
		Add `+t.yellow(t.bold("// @safe-sink: a short explanation why its safe"))+" here to suppress this finding.",r+=`
  ${t.gray(`Line ${e.line}:`)}	${t.red("(>>) "+t.bold(s.offendingLine))}`,r+=wt(s,t),r)}function Ct(e,t){let n="";if(e.before&&e.before.length)for(let i of e.before)n+=`
  ${t.gray(`Line ${i.line+1}:`)}	${t.dim(i.text)}`;return n}function wt(e,t){let n="";if(e.after&&e.after.length)for(let i of e.after)n+=`
  ${t.gray(`Line ${i.line+1}:`)}	${t.dim(i.text)}`;return n}var Z=u(require("path")),tt=u(require("fs"));var et=require("module");var G="1.1.0",J="sinker.config.js";var K=G??process.env.npm_package_version??"0.0.0",Y=J??"sinker.config.js";var Mt=typeof require<"u"?require:et.createRequire,nt={ignoredSinks:[],ignored:["**/dist/**","**/node_modules/**","**/coverage/**","*.test.js","*.spec.js","*.min.js","*.map"],sinks:[],colors:!0,minimal:!0,contextDepth:3};function Bt(e){return{...nt,...e}}function Ot(e,t){console.warn(`Failed to load config from ${e}. Using default config.`,t)}function vt(){return Z.resolve(process.cwd(),Y)}function it(){let e=vt();if(tt.existsSync(e))try{let t=Mt(e);return Bt(t.default||t)}catch(t){Ot(e,t)}return nt}function ot(e,t){return t.some(n=>{let i="^"+n.split("*").map(a=>a.replace(/[|\\{}()[\]^$+?.]/g,"\\$&")).join(".*")+"$",o=new RegExp(i),s=e.split(/[/\\]/).pop()||"";return o.test(e)||o.test(s)||e.endsWith(n)})}var{sinks:It}=_(null),g={contextDepth:3,colors:!0,minimal:!0,config:it()};function jt(e){let t=e&&e[0]||{};return{contextDepth:t.contextDepth??g.contextDepth,colors:t.colors??g.colors,minimal:t.minimal??g.minimal,config:g.config}}var rt={meta:{name:"@webklex/eslint-plugin-sinker",version:K,namespace:"sinker"},processors:{},rules:{"no-sink":{meta:{type:"suggestion",docs:{description:"Scans your code for potentially dangerous sinks and sources.",category:"Security",recommended:!0},schema:[{type:"object",properties:{contextDepth:{type:"number",minimum:0,maximum:10},colors:{type:"boolean"},minimal:{type:"boolean"}},additionalProperties:!1}]},create(e){let t=jt(e.options),n=z(t.colors);return{Program(){let i=e.getFilename?.()??e.filename??"";if(ot(i,t.config.ignored))return;let o=e.sourceCode?.text??e.getSourceCode?.().text??"",s=k({text:o,displayPath:i,compiledSinks:It,lineOffset:0,options:{contextDepth:t.contextDepth}});for(let a of s){let r=Q(a,n,t.minimal,!1);e.report({loc:{start:{line:a.line,column:0},end:{line:a.line,column:a.context.offendingLine.length}},message:r})}}}}}},configs:{recommended:{plugins:["sinker"],rules:{"sinker/no-sink":["warn",{contextDepth:3,colors:!0,minimal:!0}]}}}};var st=rt;module.exports=st;
